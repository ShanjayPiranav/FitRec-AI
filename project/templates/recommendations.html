{% extends "base.html" %}

{% block title %}Workout Recommendations - FitRec AI{% endblock %}

{% block content %}
<div class="main-content">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="fw-bold mb-2">
                        <i class="fas fa-lightbulb text-primary me-2"></i>
                        Personalized Recommendations
                    </h1>
                    <p class="text-muted mb-0">
                        AI-powered workout suggestions tailored to your preferences and goals
                    </p>
                </div>
                <div class="text-end">
                    <div class="badge bg-info fs-6">
                        <i class="fas fa-brain me-1"></i>
                        Diversity Score: {{ "%.1f"|format(diversity_score * 100) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Explanation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-2">
                                <i class="fas fa-robot text-primary me-2"></i>
                                How AI Makes Recommendations
                            </h5>
                            <p class="mb-0 text-muted">
                                Our reinforcement learning algorithm analyzes your workout history, preferences, 
                                and feedback to suggest workouts that match your fitness level and goals. 
                                The system continuously learns and adapts to provide better recommendations over time.
                            </p>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="workout-card">
                                <h6 class="mb-1">Recommendation Quality</h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: {{ diversity_score * 100 }}%"></div>
                                </div>
                                <small class="text-white-50">Based on your preferences</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Recommendations -->
    <div class="row">
        {% for workout in workouts %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 workout-recommendation">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-dumbbell text-primary me-2"></i>
                        {{ workout.name }}
                    </h5>
                    <span class="difficulty-badge difficulty-{{ workout.difficulty }}">
                        {{ workout.difficulty|title }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Category</small><br>
                            <span class="badge bg-primary">{{ workout.category|title }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Equipment</small><br>
                            <span class="badge bg-secondary">{{ workout.equipment|title }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Duration</small><br>
                            <strong>{{ workout.duration }} min</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Calories</small><br>
                            <strong>{{ workout.calories_burn }} cal</strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Muscle Groups</small><br>
                        <span class="text-muted">{{ workout.muscle_group }}</span>
                    </div>
                    
                    {% if workout.description %}
                    <div class="mb-3">
                        <small class="text-muted">Description</small><br>
                        <p class="mb-0">{{ workout.description }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('workout_detail', workout_id=workout.id) }}" class="btn btn-primary">
                            <i class="fas fa-info-circle me-2"></i>View Details
                        </a>
                        <button class="btn btn-success" onclick="startWorkout({{ workout.id }})">
                            <i class="fas fa-play me-2"></i>Start Workout
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Recommendations Message -->
    {% if not workouts %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No recommendations available</h4>
                <p class="text-muted">Complete some workouts first to get personalized recommendations!</p>
                <a href="{{ url_for('workout_history') }}" class="btn btn-primary">
                    <i class="fas fa-history me-2"></i>View All Workouts
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recommendation Filters -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter text-primary me-2"></i>Customize Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="strength">Strength</option>
                                <option value="cardio">Cardio</option>
                                <option value="flexibility">Flexibility</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" id="difficultyFilter">
                                <option value="">All Levels</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Duration (min)</label>
                            <select class="form-select" id="durationFilter">
                                <option value="">Any Duration</option>
                                <option value="0-15">0-15 min</option>
                                <option value="15-30">15-30 min</option>
                                <option value="30-60">30-60 min</option>
                                <option value="60+">60+ min</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Equipment</label>
                            <select class="form-select" id="equipmentFilter">
                                <option value="">Any Equipment</option>
                                <option value="bodyweight">Bodyweight</option>
                                <option value="dumbbells">Dumbbells</option>
                                <option value="barbell">Barbell</option>
                                <option value="none">No Equipment</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workout Completion Modal -->
<div class="modal fade" id="workoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Complete Workout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workoutForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="duration" name="duration" min="1" max="300" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Intensity Level (1-10)</label>
                            <input type="range" class="form-range" id="intensity" name="intensity" min="1" max="10" value="7">
                            <div class="text-center">
                                <span id="intensityValue">7</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enjoyment Rating (1-5)</label>
                            <div class="rating-input">
                                {% for i in range(1, 6) %}
                                <input type="radio" name="enjoyment_rating" value="{{ i }}" id="enjoyment_{{ i }}">
                                <label for="enjoyment_{{ i }}" class="rating-star">★</label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Difficulty Rating (1-5)</label>
                            <div class="rating-input">
                                {% for i in range(1, 6) %}
                                <input type="radio" name="difficulty_rating" value="{{ i }}" id="difficulty_{{ i }}">
                                <label for="difficulty_{{ i }}" class="rating-star">★</label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Completion Rate (0-100%)</label>
                            <input type="range" class="form-range" id="completion_rate" name="completion_rate" min="0" max="100" value="100">
                            <div class="text-center">
                                <span id="completionValue">100%</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Notes (optional)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="How was your workout?"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="completeWorkout()">
                    <i class="fas fa-check me-2"></i>Complete Workout
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.workout-recommendation {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.workout-recommendation:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.rating-input {
    display: flex;
    justify-content: center;
    gap: 5px;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-star {
    font-size: 1.5em;
    color: #ddd;
    cursor: pointer;
    transition: color 0.3s ease;
}

.rating-input input[type="radio"]:checked ~ .rating-star,
.rating-star:hover,
.rating-star:hover ~ .rating-star {
    color: #FFD700;
}
</style>

<script>
let currentWorkoutId = null;

function startWorkout(workoutId) {
    currentWorkoutId = workoutId;
    const modal = new bootstrap.Modal(document.getElementById('workoutModal'));
    modal.show();
}

function completeWorkout() {
    const form = document.getElementById('workoutForm');
    const formData = new FormData(form);
    
    const data = {
        duration: parseInt(formData.get('duration')),
        intensity: parseInt(document.getElementById('intensity').value),
        enjoyment_rating: parseInt(formData.get('enjoyment_rating')),
        difficulty_rating: parseInt(formData.get('difficulty_rating')),
        completion_rate: parseInt(document.getElementById('completion_rate').value) / 100,
        notes: formData.get('notes')
    };
    
    fetch(`/complete_workout/${currentWorkoutId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('workoutModal')).hide();
            location.reload();
        } else {
            alert('Error completing workout: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error completing workout');
    });
}

// Update range input values
document.getElementById('intensity').addEventListener('input', function() {
    document.getElementById('intensityValue').textContent = this.value;
});

document.getElementById('completion_rate').addEventListener('input', function() {
    document.getElementById('completionValue').textContent = this.value + '%';
});

function applyFilters() {
    // Implementation for filtering recommendations
    console.log('Applying filters...');
}

function resetFilters() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('difficultyFilter').value = '';
    document.getElementById('durationFilter').value = '';
    document.getElementById('equipmentFilter').value = '';
}
</script>
{% endblock %}
